<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Bookmark Master{% endblock %}</title>
    
    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'scale-in': 'scaleIn 0.2s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(10px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        },
                        scaleIn: {
                            '0%': { transform: 'scale(0.95)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' }
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.6"></script>
    <script>
        // Configure HTMX to include credentials (cookies) in all requests
        document.addEventListener('DOMContentLoaded', function() {
            htmx.config.includeCredentials = true;
            htmx.config.withCredentials = true;
        });
    </script>
    
    <!-- Sortable.js for drag & drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    
    <!-- Custom CSS -->
    <style>
        .bookmark-card {
            transition: all 0.3s ease;
        }
        .bookmark-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        .dark .loading-skeleton {
            background: linear-gradient(90deg, #374151 25%, #4b5563 50%, #374151 75%);
            background-size: 200% 100%;
        }
    </style>
    
    {% block head %}{% endblock %}
</head>
<body class="h-full bg-gray-50 dark:bg-gray-900 transition-colors duration-300">
    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div id="flash-messages" class="fixed top-4 right-4 z-50 space-y-2">
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} px-4 py-3 rounded-lg shadow-lg animate-slide-up"
                         data-category="{{ category }}">
                        <div class="flex items-center">
                            <div class="flex-1">
                                {{ message }}
                            </div>
                            <button onclick="this.parentElement.parentElement.remove()" 
                                    class="ml-3 text-sm font-semibold">
                                Ã—
                            </button>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    {% if user %}
        <!-- Navigation -->
        <nav class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <a href="{{ url_for('main.dashboard') }}" 
                           class="flex items-center space-x-2 text-xl font-bold text-blue-600 dark:text-blue-400">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                            </svg>
                            <span>Bookmark Master</span>
                        </a>
                    </div>
                    
                    <!-- Desktop Navigation -->
                    <div class="hidden md:flex items-center space-x-4">
                        <a href="{{ url_for('main.dashboard') }}" 
                           class="nav-link {% if request.endpoint == 'main.dashboard' %}active{% endif %}">
                            Dashboard
                        </a>
                        <a href="{{ url_for('main.bookmarks') }}" 
                           class="nav-link {% if request.endpoint == 'main.bookmarks' %}active{% endif %}">
                            Bookmarks
                        </a>
                        <a href="{{ url_for('main.categories') }}" 
                           class="nav-link {% if request.endpoint == 'main.categories' %}active{% endif %}">
                            Categories
                        </a>
                        <a href="{{ url_for('main.tags') }}" 
                           class="nav-link {% if request.endpoint == 'main.tags' %}active{% endif %}">
                            Tags
                        </a>
                        <a href="{{ url_for('main.search') }}" 
                           class="nav-link {% if request.endpoint == 'main.search' %}active{% endif %}">
                            Search
                        </a>
                        
                        <!-- Add Bookmark Button -->
                        <a href="{{ url_for('main.add_bookmark') }}" 
                           class="btn btn-primary">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Add
                        </a>
                        
                        <!-- User Menu -->
                        <div class="relative" x-data="{ open: false }">
                            <button @click="open = !open" 
                                    class="flex items-center space-x-2 text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white">
                                <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-white text-sm font-medium">
                                    {{ user.display_name[0] if user.display_name else user.email[0] }}
                                </div>
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            
                            <div x-show="open" @click.away="open = false" 
                                 class="absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-md shadow-lg py-1 z-50">
                                <a href="{{ url_for('main.settings') }}" 
                                   class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                                    Settings
                                </a>
                                <a href="{{ url_for('main.logout') }}" 
                                   class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                                    Logout
                                </a>
                            </div>
                        </div>
                        
                        <!-- Theme Toggle -->
                        <button id="theme-toggle" 
                                class="p-2 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 rounded-lg">
                            <svg id="theme-toggle-dark-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                            </svg>
                            <svg id="theme-toggle-light-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </nav>
    {% endif %}

    <!-- Main Content -->
    <main class="{% if user %}pt-0{% else %}pt-16{% endif %}">
        {% block content %}{% endblock %}
    </main>

    <!-- Alpine.js for interactive components -->
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    
    <!-- Custom JavaScript -->
    <script>
        // Theme toggle functionality
        const themeToggleBtn = document.getElementById('theme-toggle');
        const themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
        const themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');

        if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
            themeToggleLightIcon.classList.remove('hidden');
        } else {
            themeToggleDarkIcon.classList.remove('hidden');
        }

        if (themeToggleBtn) {
            themeToggleBtn.addEventListener('click', function() {
                themeToggleDarkIcon.classList.toggle('hidden');
                themeToggleLightIcon.classList.toggle('hidden');

                if (localStorage.getItem('color-theme')) {
                    if (localStorage.getItem('color-theme') === 'light') {
                        document.documentElement.classList.add('dark');
                        localStorage.setItem('color-theme', 'dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                        localStorage.setItem('color-theme', 'light');
                    }
                } else {
                    if (document.documentElement.classList.contains('dark')) {
                        document.documentElement.classList.remove('dark');
                        localStorage.setItem('color-theme', 'light');
                    } else {
                        document.documentElement.classList.add('dark');
                        localStorage.setItem('color-theme', 'dark');
                    }
                }
            });
        }

        // Auto-hide flash messages
        setTimeout(() => {
            const flashMessages = document.getElementById('flash-messages');
            if (flashMessages) {
                flashMessages.style.transition = 'opacity 0.5s ease-out';
                flashMessages.style.opacity = '0';
                setTimeout(() => flashMessages.remove(), 500);
            }
        }, 5000);

        // Global search shortcut
        document.addEventListener('keydown', function(e) {
            if (e.key === '/' && !e.ctrlKey && !e.metaKey && !e.altKey) {
                const activeElement = document.activeElement;
                if (activeElement.tagName !== 'INPUT' && activeElement.tagName !== 'TEXTAREA') {
                    e.preventDefault();
                    const searchInput = document.querySelector('input[type="search"], input[name="query"]');
                    if (searchInput) {
                        searchInput.focus();
                    }
                }
            }
        });

        // HTMX loading indicators
        document.addEventListener('htmx:beforeRequest', function(evt) {
            const indicator = evt.target.querySelector('.loading-indicator');
            if (indicator) {
                indicator.classList.remove('hidden');
            }
        });

        document.addEventListener('htmx:afterRequest', function(evt) {
            const indicator = evt.target.querySelector('.loading-indicator');
            if (indicator) {
                indicator.classList.add('hidden');
            }
        });
    </script>

    <!-- CSS Classes -->
    <style>
        .nav-link {
            @apply px-3 py-2 rounded-md text-sm font-medium text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-200;
        }
        .nav-link.active {
            @apply bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300;
        }
        .btn {
            @apply inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 transition-colors duration-200;
        }
        .btn-primary {
            @apply bg-blue-600 hover:bg-blue-700 text-white focus:ring-blue-500;
        }
        .btn-secondary {
            @apply bg-gray-200 hover:bg-gray-300 text-gray-900 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-100 focus:ring-gray-500;
        }
        .btn-danger {
            @apply bg-red-600 hover:bg-red-700 text-white focus:ring-red-500;
        }
        .alert {
            @apply border-l-4;
        }
        .alert-info {
            @apply bg-blue-50 border-blue-400 text-blue-700 dark:bg-blue-900 dark:text-blue-200;
        }
        .alert-success {
            @apply bg-green-50 border-green-400 text-green-700 dark:bg-green-900 dark:text-green-200;
        }
        .alert-warning {
            @apply bg-yellow-50 border-yellow-400 text-yellow-700 dark:bg-yellow-900 dark:text-yellow-200;
        }
        .alert-error {
            @apply bg-red-50 border-red-400 text-red-700 dark:bg-red-900 dark:text-red-200;
        }
    </style>

    {% block scripts %}{% endblock %}
</body>
</html>
